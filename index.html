<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>5ç¯€ãƒªãƒ³ã‚¯è„šï¼ˆ2ã‚µãƒ¼ãƒœï¼‰é€šéç‚¹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</title>
<style>
  :root { --bg:#0b0f14; --fg:#e8eef7; --mut:#9fb0c3; --card:#121a24; --line:#223041; }
  body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif; background:var(--bg); color:var(--fg); }
  header{ padding:14px 16px; border-bottom:1px solid var(--line); }
  header h1{ margin:0; font-size:16px; font-weight:700; }
  header p{ margin:6px 0 0; color:var(--mut); font-size:12px; line-height:1.5; }
  main{ display:grid; grid-template-columns: 1.1fr 0.9fr; gap:12px; padding:12px; }
  @media (max-width: 980px){ main{ grid-template-columns: 1fr; } }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; overflow:hidden; }
  .hd{ padding:10px 12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .ttl{ font-size:13px; font-weight:700; }
  .bd{ padding:12px; }
  canvas{ width:100%; height:auto; display:block; background:linear-gradient(180deg,#0b0f14,#0a111a); }
  .btns{ display:flex; flex-wrap:wrap; gap:8px; }
  button{
    cursor:pointer; border:1px solid var(--line); background:#0b1119; color:var(--fg);
    padding:8px 10px; border-radius:10px; font-size:12px; font-weight:700;
  }
  button.primary{ background:#132235; border-color:#2a4a71; }
  button:disabled{ opacity:.5; cursor:not-allowed; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .row{ display:grid; gap:6px; padding:8px; border:1px solid var(--line); border-radius:10px; }
  .row label{ font-size:12px; color:var(--mut); display:flex; justify-content:space-between; gap:10px; }
  input[type="range"]{ width:100%; }
  .small{ font-size:12px; color:var(--mut); line-height:1.5; }
  .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; color:var(--mut); white-space:pre-wrap; }
  .chip{ display:inline-flex; gap:8px; align-items:center; padding:6px 8px; border:1px solid var(--line); border-radius:999px; background:#0b1119; font-size:12px; color:var(--fg); }
  .chip input{ transform: translateY(1px); }
</style>
</head>
<body>
<header>
  <h1>5ç¯€ãƒªãƒ³ã‚¯è„šï¼ˆ2ã‚µãƒ¼ãƒœï¼‰ï½œé€šéç‚¹ï¼ˆæ°´å¹³ã«ç­‰é–“éš”ï¼‹ä¸­å¤®ä¸Šã®1ç‚¹ï¼‰ã‚’ç­‰é€Ÿã§é€šã‚‹</h1>
  <p>
    å·¦å³ã«åŒã˜é«˜ã•ã®ã‚µãƒ¼ãƒœï¼ˆåŸºç‚¹O1,O2ï¼‰â†’è¿‘ä½ãƒªãƒ³ã‚¯ï¼ˆL1,L2ï¼‰â†’è‚˜ï¼ˆE1,E2ï¼‰â†’é ä½ãƒªãƒ³ã‚¯ï¼ˆL3,L4ï¼‰â†’è¶³å…ˆF ã®é–‰ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚<br>
    å„ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã€Œè¶³å…ˆFâ†’è‚˜Eã€ã®å††ã¨ã€ŒåŸºç‚¹Oâ†’è‚˜Eã€ã®å††ã®äº¤ç‚¹ã‹ã‚‰è‚˜ä½ç½®ã‚’æ±ºã‚ã€ã‚µãƒ¼ãƒœè§’ï¼ˆOâ†’Eã®è§’åº¦ï¼‰ã‚’ç®—å‡ºã—ã¾ã™ğŸ˜Š
  </p>
</header>

<main>
  <section class="card">
    <div class="hd">
      <div class="ttl">ãƒ“ãƒ¥ãƒ¼</div>
      <div class="btns">
        <button id="btnPlay" class="primary">â–¶ å†ç”Ÿ</button>
        <button id="btnPause" disabled>â¸ åœæ­¢</button>
        <button id="btnReset">â†º ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="btnClearTarget">âœ• æ‰‹å‹•ç›®æ¨™è§£é™¤</button>
      </div>
    </div>
    <canvas id="cv" width="980" height="700"></canvas>
    <div class="bd">
      <div class="small">
        <b>æ“ä½œï¼š</b>ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®ä½ç½®ãŒä¸€æ™‚çš„ãªã€Œç›®æ¨™ç‚¹ã€ã«ãªã‚Šã¾ã™ï¼ˆé€šéç‚¹ã®ä»£ã‚ã‚Šã«è¿½å¾“ï¼‰ã€‚ãƒ›ã‚¤ãƒ¼ãƒ«ã§æ‹¡å¤§ç¸®å°ã€‚
      </div>
      <div class="mono" id="status"></div>
    </div>
  </section>

  <aside class="card">
    <div class="hd"><div class="ttl">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div></div>
    <div class="bd">
      <div class="grid">
        <div class="row">
          <label>ã‚µãƒ¼ãƒœé–“è·é›¢ d <span id="v_d"></span></label>
          <input id="d" type="range" min="40" max="220" step="1" value="120">
        </div>
        <div class="row">
          <label>ã‚µãƒ¼ãƒœé«˜ã• yBase <span id="v_yBase"></span></label>
          <input id="yBase" type="range" min="40" max="240" step="1" value="150">
        </div>
        <div class="row">
          <label>è¿‘ä½ L1ï¼ˆå·¦ï¼‰<span id="v_L1"></span></label>
          <input id="L1" type="range" min="40" max="200" step="1" value="95">
        </div>
        <div class="row">
          <label>è¿‘ä½ L2ï¼ˆå³ï¼‰<span id="v_L2"></span></label>
          <input id="L2" type="range" min="40" max="200" step="1" value="95">
        </div>
        <div class="row">
          <label>é ä½ L3ï¼ˆå·¦ï¼‰<span id="v_L3"></span></label>
          <input id="L3" type="range" min="40" max="220" step="1" value="125">
        </div>
        <div class="row">
          <label>é ä½ L4ï¼ˆå³ï¼‰<span id="v_L4"></span></label>
          <input id="L4" type="range" min="40" max="220" step="1" value="125">
        </div>
        <div class="row">
          <label>é€Ÿåº¦ï¼ˆç­‰é€Ÿï¼‰<span id="v_speed"></span></label>
          <input id="speed" type="range" min="20" max="260" step="1" value="95">
        </div>
        <div class="row">
          <label>è»Œè·¡ã®è¡¨ç¤ºç‚¹æ•° <span id="v_tail"></span></label>
          <input id="tail" type="range" min="50" max="900" step="10" value="300">
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0;">

      <div class="grid">
        <div class="row">
          <label>æ°´å¹³ç‚¹ã®æ•° Nï¼ˆ4ã€œ6ï¼‰<span id="v_N"></span></label>
          <input id="N" type="range" min="4" max="6" step="1" value="5">
        </div>
        <div class="row">
          <label>æ°´å¹³ç‚¹ã®å¹… W <span id="v_W"></span></label>
          <input id="W" type="range" min="80" max="380" step="1" value="220">
        </div>
        <div class="row">
          <label>æ°´å¹³ãƒ©ã‚¤ãƒ³ y0 <span id="v_y0"></span></label>
          <input id="y0" type="range" min="-120" max="120" step="1" value="0">
        </div>
        <div class="row">
          <label>ä¸­å¤®ä¸Šç‚¹ã®é«˜ã• H <span id="v_H"></span></label>
          <input id="H" type="range" min="10" max="280" step="1" value="140">
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--line);margin:14px 0;">

      <div class="row">
        <label>è‚˜ã®åˆ†å²ï¼ˆå††ã®äº¤ç‚¹ã®ã©ã£ã¡ã‚’æ¡ã‚‹ã‹ï¼‰</label>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <span class="chip"><input id="elbowLeftUp" type="checkbox" checked><label for="elbowLeftUp">å·¦ï¼šä¸Šå´</label></span>
          <span class="chip"><input id="elbowRightUp" type="checkbox" checked><label for="elbowRightUp">å³ï¼šä¸Šå´</label></span>
        </div>
        <div class="small">â€»ã€Œä¸Šå´ã€ã¯ y ãŒå¤§ãã„äº¤ç‚¹ã€‚è„šã£ã½ã„å‘ãã«ãªã‚‹æ–¹ã‚’é¸ã‚“ã§ã­ã€‚</div>
      </div>
    </div>
  </aside>
</main>

<script>
/** ---------- util ---------- **/
const $ = id => document.getElementById(id);
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
const lerp = (a,b,t) => a + (b-a)*t;

function vlen(p){ return Math.hypot(p.x,p.y); }
function vsub(a,b){ return {x:a.x-b.x, y:a.y-b.y}; }
function vadd(a,b){ return {x:a.x+b.x, y:a.y+b.y}; }
function vmul(a,s){ return {x:a.x*s, y:a.y*s}; }
function vnorm(a){ const L=vlen(a)||1e-9; return {x:a.x/L, y:a.y/L}; }

/** å††ã¨å††ã®äº¤ç‚¹ï¼ˆæœ€å¤§2ç‚¹ï¼‰ */
function circleCircleIntersections(c0, r0, c1, r1){
  const d = vlen(vsub(c1,c0));
  if(d < 1e-9) return {ok:false, pts:[]};
  if(d > r0 + r1) return {ok:false, pts:[]};
  if(d < Math.abs(r0 - r1)) return {ok:false, pts:[]};

  const a = (r0*r0 - r1*r1 + d*d) / (2*d);
  const h2 = r0*r0 - a*a;
  if(h2 < -1e-9) return {ok:false, pts:[]};
  const h = Math.sqrt(Math.max(0,h2));

  const ex = vnorm(vsub(c1,c0));
  const p2 = vadd(c0, vmul(ex,a));
  const ey = {x:-ex.y, y:ex.x};

  const p3 = vadd(p2, vmul(ey, h));
  const p4 = vadd(p2, vmul(ey,-h));

  return {ok:true, pts:[p3,p4], d};
}

/** ---------- 5-bar IK ----------
 * å·¦å´ï¼šO1--(L1)-->E1--(L3)-->F
 * å³å´ï¼šO2--(L2)-->E2--(L4)-->F
 * ä¸ãˆãŸFã«å¯¾ã—ã¦ã€E1ã¯ã€ŒO1ä¸­å¿ƒL1ã€ã¨ã€ŒFä¸­å¿ƒL3ã€ã®äº¤ç‚¹
 * åŒæ§˜ã«E2ã¯ã€ŒO2ä¸­å¿ƒL2ã€ã¨ã€ŒFä¸­å¿ƒL4ã€ã®äº¤ç‚¹
 */
function solveFiveBar(params, F, branch){
  const {O1,O2,L1,L2,L3,L4} = params;

  const iL = circleCircleIntersections(O1, L1, F, L3);
  const iR = circleCircleIntersections(O2, L2, F, L4);

  if(!iL.ok || !iR.ok) return {ok:false, reason:"unreachable", iL, iR};

  // åˆ†å²é¸æŠï¼šä¸Šå´ï¼ˆyå¤§ï¼‰or ä¸‹å´
  const pick = (pts, wantUp) => {
    if(pts.length<2) return pts[0];
    const pUp = (pts[0].y >= pts[1].y) ? pts[0] : pts[1];
    const pDn = (pts[0].y <  pts[1].y) ? pts[0] : pts[1];
    return wantUp ? pUp : pDn;
  };

  const E1 = pick(iL.pts, branch.leftUp);
  const E2 = pick(iR.pts, branch.rightUp);

  const th1 = Math.atan2(E1.y - O1.y, E1.x - O1.x);
  const th2 = Math.atan2(E2.y - O2.y, E2.x - O2.x);

  return {ok:true, O1,O2,E1,E2,F, th1, th2, iL, iR};
}

/** ---------- Waypointsï¼ˆæ°´å¹³Nç‚¹ï¼‹ä¸­å¤®ä¸Š1ç‚¹ï¼‰ ---------- **/
function buildWaypoints(N, W, y0, H){
  const pts = [];
  const half = W/2;
  for(let i=0;i<N;i++){
    const t = (N===1)?0.5 : i/(N-1);
    pts.push({x: lerp(-half, half, t), y: y0});
  }
  const apex = {x:0, y:y0+H};
  return [...pts, apex, pts[0]];
}

function makePathWalker(points){
  const seg = [];
  let total=0;
  for(let i=0;i<points.length-1;i++){
    const a=points[i], b=points[i+1];
    const L=vlen(vsub(b,a));
    seg.push({a,b,L,start:total});
    total += L;
  }
  return {
    total,
    at(s){
      if(total<1e-9) return points[0];
      s = ((s%total)+total)%total;
      let k=seg.length-1;
      for(let i=0;i<seg.length;i++){
        if(s>=seg[i].start && s<=seg[i].start+seg[i].L+1e-9){ k=i; break; }
      }
      const sg=seg[k];
      const t = (sg.L<1e-9)?0 : (s-sg.start)/sg.L;
      return {x: lerp(sg.a.x, sg.b.x, clamp(t,0,1)), y: lerp(sg.a.y, sg.b.y, clamp(t,0,1))};
    }
  };
}

/** ---------- UI / View ---------- **/
const cv = $("cv");
const ctx = cv.getContext("2d");
const statusEl = $("status");
const btnPlay = $("btnPlay");
const btnPause = $("btnPause");
const btnReset = $("btnReset");
const btnClearTarget = $("btnClearTarget");

const view = { scale: 2.0, cx: cv.width*0.52, cy: cv.height*0.62 };
function worldToScreen(p){ return {x: view.cx + p.x*view.scale, y: view.cy - p.y*view.scale}; }
function screenToWorld(p){ return {x:(p.x-view.cx)/view.scale, y:(view.cy-p.y)/view.scale}; }

cv.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const factor = (e.deltaY>0)?0.92:1.08;
  view.scale = clamp(view.scale*factor, 0.7, 6.0);
},{passive:false});

let manualTarget = null;
cv.addEventListener("pointerdown",(e)=>{
  const r = cv.getBoundingClientRect();
  const p = {x:(e.clientX-r.left)*(cv.width/r.width), y:(e.clientY-r.top)*(cv.height/r.height)};
  manualTarget = screenToWorld(p);
});

function getParams(){
  const d = +$("d").value;
  const yBase = +$("yBase").value;
  const L1 = +$("L1").value;
  const L2 = +$("L2").value;
  const L3 = +$("L3").value;
  const L4 = +$("L4").value;
  return {
    d,yBase,L1,L2,L3,L4,
    O1:{x:-d/2, y:yBase},
    O2:{x: d/2, y:yBase},
  };
}
function getPathSettings(){
  return { N:+$("N").value, W:+$("W").value, y0:+$("y0").value, H:+$("H").value };
}
function getBranch(){
  return { leftUp: $("elbowLeftUp").checked, rightUp: $("elbowRightUp").checked };
}
function updateLabels(){
  const map = [
    ["d","v_d","px"], ["yBase","v_yBase",""], ["L1","v_L1","px"], ["L2","v_L2","px"],
    ["L3","v_L3","px"], ["L4","v_L4","px"], ["speed","v_speed","px/s"], ["tail","v_tail",""],
    ["N","v_N",""], ["W","v_W",""], ["y0","v_y0",""], ["H","v_H",""]
  ];
  for(const [id,vid,suf] of map){
    const v = $(id).value;
    $(vid).textContent = suf ? `${v}${suf}` : `${v}`;
  }
}
document.querySelectorAll("input").forEach(i=>i.addEventListener("input",updateLabels));
updateLabels();

/** ---------- Draw ---------- **/
function drawGrid(){
  ctx.clearRect(0,0,cv.width,cv.height);

  // grid
  ctx.save();
  ctx.globalAlpha = 0.25;
  ctx.strokeStyle = "#2a3645";
  ctx.lineWidth = 1;
  const step = 50;
  for(let x=0;x<=cv.width;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cv.height); ctx.stroke(); }
  for(let y=0;y<=cv.height;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cv.width,y); ctx.stroke(); }
  ctx.restore();

  // axes
  ctx.save();
  ctx.globalAlpha = 0.6;
  ctx.strokeStyle = "#2f4560";
  ctx.lineWidth = 2;
  const o = worldToScreen({x:0,y:0});
  ctx.beginPath(); ctx.moveTo(0,o.y); ctx.lineTo(cv.width,o.y); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(o.x,0); ctx.lineTo(o.x,cv.height); ctx.stroke();
  ctx.restore();
}

function dot(p, r, fill){
  const s = worldToScreen(p);
  ctx.beginPath(); ctx.fillStyle = fill; ctx.arc(s.x,s.y,r,0,Math.PI*2); ctx.fill();
}
function seg(a,b,w,col,alpha=1){
  const A=worldToScreen(a), B=worldToScreen(b);
  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.strokeStyle = col;
  ctx.lineWidth = w;
  ctx.lineCap = "round";
  ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke();
  ctx.restore();
}

function drawWaypoints(waypoints){
  ctx.save();
  ctx.strokeStyle="#6f93be";
  ctx.globalAlpha=0.55;
  ctx.lineWidth=2;
  for(let i=0;i<waypoints.length-1;i++){
    const a=worldToScreen(waypoints[i]), b=worldToScreen(waypoints[i+1]);
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
  }
  ctx.globalAlpha=0.95;
  for(const p of waypoints){
    const s=worldToScreen(p);
    ctx.fillStyle="#9ec0ff";
    ctx.beginPath(); ctx.arc(s.x,s.y,4,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}

function drawTarget(T){
  const s = worldToScreen(T);
  ctx.save();
  ctx.strokeStyle="#ff8d8d";
  ctx.lineWidth=2;
  ctx.globalAlpha=0.95;
  ctx.beginPath(); ctx.arc(s.x,s.y,10,0,Math.PI*2); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(s.x-14,s.y); ctx.lineTo(s.x+14,s.y); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(s.x,s.y-14); ctx.lineTo(s.x,s.y+14); ctx.stroke();
  ctx.restore();
}

/** ---------- Animation ---------- **/
let running=false;
let tPrev=null;
let sAlong=0;
let tail=[];

function reset(){
  tPrev=null;
  sAlong=0;
  tail=[];
  // manualTargetã¯æ®‹ã—ã¦ã‚‚ã„ã„ã‘ã©ã€ã“ã“ã§ã¯æ®‹ã™
}
btnReset.addEventListener("click", reset);

btnClearTarget.addEventListener("click", ()=>{ manualTarget=null; });

btnPlay.addEventListener("click", ()=>{
  running=true; btnPlay.disabled=true; btnPause.disabled=false;
  requestAnimationFrame(tick);
});
btnPause.addEventListener("click", ()=>{
  running=false; btnPlay.disabled=false; btnPause.disabled=true;
  tPrev=null;
});

function tick(ts){
  if(!running) return;
  if(tPrev==null) tPrev=ts;
  const dt=(ts-tPrev)/1000; tPrev=ts;

  const params=getParams();
  const ps=getPathSettings();
  const waypoints=buildWaypoints(ps.N, ps.W, ps.y0, ps.H);
  const walker=makePathWalker(waypoints);

  const speed=+$("speed").value;
  sAlong += speed*dt;

  const target = manualTarget ?? walker.at(sAlong);

  const branch=getBranch();
  const sol = solveFiveBar(params, target, branch);

  // æç”»
  drawGrid();
  drawWaypoints(waypoints);
  drawTarget(target);

  // è¶³å…ˆè»Œè·¡
  if(sol.ok){
    tail.push(sol.F);
    const maxTail=+$("tail").value;
    if(tail.length>maxTail) tail.splice(0, tail.length-maxTail);

    if(tail.length>1){
      ctx.save();
      ctx.strokeStyle="#f5c96b";
      ctx.globalAlpha=0.7;
      ctx.lineWidth=2;
      ctx.beginPath();
      let p0=worldToScreen(tail[0]); ctx.moveTo(p0.x,p0.y);
      for(let i=1;i<tail.length;i++){ const p=worldToScreen(tail[i]); ctx.lineTo(p.x,p.y); }
      ctx.stroke();
      ctx.restore();
    }

    // ãƒªãƒ³ã‚¯æç”»ï¼ˆè¿‘ä½:å¤ªã‚ã€é ä½:å°‘ã—ç´°ã‚ï¼‰
    seg(sol.O1, sol.E1, 6, "#e8eef7", 0.95);
    seg(sol.O2, sol.E2, 6, "#e8eef7", 0.95);
    seg(sol.E1, sol.F, 5, "#cfe0ff", 0.95);
    seg(sol.E2, sol.F, 5, "#cfe0ff", 0.95);

    // ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³
    seg(sol.O1, sol.O2, 2, "#d5e6ff", 0.8);

    // ç‚¹
    dot(sol.O1, 7, "#9ec0ff"); dot(sol.O2, 7, "#9ec0ff");
    dot(sol.E1, 6, "#a8ffb6"); dot(sol.E2, 6, "#a8ffb6");
    dot(sol.F,  7, "#ff8d8d");

    const th1 = (sol.th1*180/Math.PI).toFixed(1);
    const th2 = (sol.th2*180/Math.PI).toFixed(1);

    statusEl.textContent =
      `Î¸1=${th1}Â°, Î¸2=${th2}Â°\n` +
      `F=(${sol.F.x.toFixed(1)}, ${sol.F.y.toFixed(1)})  target=(${target.x.toFixed(1)}, ${target.y.toFixed(1)})\n` +
      `params: d=${params.d}, yBase=${params.yBase}, L1=${params.L1}, L2=${params.L2}, L3=${params.L3}, L4=${params.L4}\n` +
      (manualTarget ? `manualTarget ONï¼ˆã‚¯ãƒªãƒƒã‚¯æŒ‡å®šï¼‰` : `path_s=${sAlong.toFixed(1)}ï¼ˆé€šéç‚¹ãƒ«ãƒ¼ãƒ—ï¼‰`);
  }else{
    // åˆ°é”ä¸èƒ½ï¼šå‰ã®tailã¯æ›´æ–°ã—ãªã„ã€‚çŠ¶æ…‹è¡¨ç¤ºï¼†è£œåŠ©å††ã‚’å‡ºã™
    statusEl.textContent =
      `åˆ°é”ä¸èƒ½ï¼ˆunreachableï¼‰: ãã®è¶³å…ˆç‚¹ã«å¯¾ã—ã¦å·¦å³ã©ã¡ã‚‰ã‹ã®å††äº¤ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n` +
      `å¯¾å‡¦ï¼šW/Hã‚’å°ã•ãã™ã‚‹ã€ãƒªãƒ³ã‚¯é•·ã‚’ä¼¸ã°ã™ã€yBaseã‚’ä¸Šã’ã‚‹ã€é€šéç‚¹ã‚’è¿‘ã¥ã‘ã‚‹ã€åˆ†å²ï¼ˆä¸Š/ä¸‹ï¼‰ã‚’å¤‰ãˆã‚‹ã€‚`;

    // è£œåŠ©ï¼šå·¦å³ã®å¯å‹•ãƒªãƒ³ã‚°ï¼ˆè–„ãï¼‰
    ctx.save();
    ctx.globalAlpha=0.12;
    ctx.strokeStyle="#9ec0ff";
    ctx.lineWidth=2;

    // å·¦å´ reachable annulus around O1 with radii [|L1-L3|, L1+L3]
    const O1s=worldToScreen(params.O1), O2s=worldToScreen(params.O2);
    const rLmin=Math.abs(params.L1-params.L3)*view.scale;
    const rLmax=(params.L1+params.L3)*view.scale;
    ctx.beginPath(); ctx.arc(O1s.x,O1s.y,rLmax,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.arc(O1s.x,O1s.y,rLmin,0,Math.PI*2); ctx.stroke();

    const rRmin=Math.abs(params.L2-params.L4)*view.scale;
    const rRmax=(params.L2+params.L4)*view.scale;
    ctx.beginPath(); ctx.arc(O2s.x,O2s.y,rRmax,0,Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.arc(O2s.x,O2s.y,rRmin,0,Math.PI*2); ctx.stroke();

    ctx.restore();

    // è¶³å…ˆç‚¹
    dot(target, 7, "#ff8d8d");
    dot(params.O1,7,"#9ec0ff"); dot(params.O2,7,"#9ec0ff");
  }

  requestAnimationFrame(tick);
}

/** åˆæœŸæç”» */
(function init(){
  drawGrid();
  const params=getParams();
  const ps=getPathSettings();
  const waypoints=buildWaypoints(ps.N, ps.W, ps.y0, ps.H);
  drawWaypoints(waypoints);
  drawTarget(waypoints[0]);
  statusEl.textContent = "â–¶ å†ç”Ÿ ã‚’æŠ¼ã™ã¨å‹•ãã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§ç›®æ¨™ç‚¹ã®æ‰‹å‹•æŒ‡å®šã‚‚ã§ãã¾ã™ã€‚";
})();
</script>
</body>
</html>
